<!-- match.component.html -->
<div class="match-container">
  <div class="match-content">
    
    <!-- Pantalla inicial -->
    <div *ngIf="!showGameModes && !showPlayerSelection && !gameStarted">
      <div class="match-header">
        <h1>Partida multijugador</h1>
        <p>Juega contra amigos u otros jugadores online</p>
      </div>
      
      <div class="match-buttons">
        <button class="play-button" (click)="playGame()">
          <svg class="button-icon" viewBox="0 0 24 24">
            <path d="M5 3l14 9-14 9V3z"></path>
          </svg>
          Jugar ahora
        </button>
      </div>
    </div>
    
    <!-- Selección de modo de juego -->
    <div *ngIf="showGameModes && !showPlayerSelection && !gameStarted">
      <div class="match-header">
        <h1>Seleccionar modo de juego</h1>
        <p>Elige cómo quieres jugar</p>
      </div>
      
      <div class="match-buttons">
        <button class="game-mode-button" (click)="selectGameMode('1v1')">
          1 vs 1
        </button>
        <button class="game-mode-button" (click)="selectGameMode('1v1v1')">
          1 vs 1 vs 1
        </button>
        <button class="game-mode-button" (click)="selectGameMode('1v1v1v1')">
          1 vs 1 vs 1 vs 1
        </button>
        <button class="game-mode-button" (click)="selectGameMode('AI')">
          Jugar contra IA
        </button>
        <button class="game-mode-button" (click)="selectGameMode('tournament')">
          Torneo (4 jugadores)
        </button>
        <button class="back-button" (click)="goBack()">
          Volver
        </button>
      </div>
    </div>
    
    <!-- Selección de jugadores -->
    <div *ngIf="showPlayerSelection && !gameStarted">
      <div class="match-header">
        <h1>Seleccionar jugadores</h1>
        <p *ngIf="!isTournament">Necesitas {{ playerCount }} jugadores para iniciar</p>
        <p *ngIf="isTournament">Selecciona 4 jugadores para el torneo</p>
      </div>
      
      <div class="player-selection">
        <div class="selected-players">
          <h4>Jugadores seleccionados ({{ selectedPlayers.length }}/{{ playerCount }})</h4>
          <div class="player-list">
            <div class="player-item" *ngFor="let player of selectedPlayers">
              <span class="player-name">{{ player.username }}</span>
              <button 
                class="remove-player" 
                *ngIf="player.id !== currentUser?.id"
                (click)="removePlayer(player)"
              >
                <svg class="button-icon" viewBox="0 0 24 24">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <div class="player-search" *ngIf="selectedPlayers.length < playerCount">
          <h4>Buscar jugadores</h4>
          <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
            </svg>
            <input 
              type="text" 
              class="search-input" 
              [(ngModel)]="searchQuery"
              (ngModelChange)="searchUsers()"
              placeholder="Buscar por nombre de usuario"
            >
          </div>
          
          <div class="search-results" *ngIf="searchQuery.trim() !== ''">
            <div *ngIf="isLoading" class="loading">
              <div class="spinner"></div>
              <p>Buscando jugadores...</p>
            </div>
            
            <div *ngIf="!isLoading && searchResults.length === 0" class="no-results">
              <p>No se encontraron resultados</p>
            </div>
            
            <div 
              class="player-item" 
              *ngFor="let player of searchResults"
              (click)="selectPlayer(player)"
            >
              <span class="player-name">{{ player.username }}</span>
              <button class="add-player">
                <svg class="button-icon" viewBox="0 0 24 24">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="back-button" (click)="goBack()">
            Volver
          </button>
          <button 
            class="start-button" 
            [disabled]="selectedPlayers.length < playerCount"
            (click)="startGame()"
          >
            Comenzar juego
          </button>
        </div>
      </div>
    </div>
    
    <!-- Pantalla de juego -->
    <div *ngIf="gameStarted" class="game-screen">
      <!-- Anunciador de combates del torneo -->
      <div *ngIf="isTournament && showAnnouncement" class="tournament-announcement">
        <div class="announcement-content">
          <h2>{{ announcementMessage }}</h2>
        </div>
      </div>
      
      <!-- Juego normal o combate de torneo en curso -->
      <div *ngIf="!showAnnouncement">
        <div class="game-header">
          <!-- Encabezado para modo torneo -->
          <div *ngIf="isTournament">
            <h2 *ngIf="tournamentRound === 'semifinals1' && currentMatch">1ª Semifinal</h2>
            <h2 *ngIf="tournamentRound === 'semifinals2' && currentMatch">2ª Semifinal</h2>
            <h2 *ngIf="tournamentRound === 'final' && currentMatch">Final del Torneo</h2>
            
            <div class="score-display" *ngIf="currentMatch">
              <div><span>{{ currentMatch.player1.username }}</span> <span class="score">{{ currentMatch.player1Score }}</span></div>
              <div>VS</div>
              <div><span>{{ currentMatch.player2.username }}</span> <span class="score">{{ currentMatch.player2Score }}</span></div>
            </div>
          </div>
          
          <!-- Encabezado para modos normales -->
          <div *ngIf="!isTournament">
            <h2>Partida en progreso</h2>
            
            <!-- Visualización de puntuaciones según el modo -->
            <div class="score-display" *ngIf="playerCount === 2 && !isAgainstAI">
              <div><span>{{ selectedPlayers[0] ? selectedPlayers[0].username : '' }}</span> <span class="score">{{ player1Score }}</span></div>
              <div>VS</div>
              <div><span>{{ selectedPlayers[1] ? selectedPlayers[1].username : '' }}</span> <span class="score">{{ player2Score }}</span></div>
            </div>
            
            <div class="score-display" *ngIf="isAgainstAI">
              <div><span>{{ currentUser?.username }}</span> <span class="score">{{ player1Score }}</span></div>
              <div>VS</div>
              <div><span>IA</span> <span class="score">{{ player2Score }}</span></div>
            </div>
            
            <div class="score-display multi-player" *ngIf="playerCount > 2 && !isAgainstAI">
              <div class="player-names-multi">
                <div class="player-name" *ngFor="let player of selectedPlayers; let i = index">
                  {{ player.username }}: 
                  <span class="score">
                    {{ i === 0 ? player1Score : i === 1 ? player2Score : i === 2 ? player3Score : player4Score }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Área de juego -->
        <div class="game-area">
          <!-- Visualización del juego para 1v1 -->
          <div class="pong-canvas" *ngIf="playerCount === 2 && !isTournament">
            <div class="paddle left-paddle"></div>
            <div class="paddle right-paddle"></div>
            <div class="ball"></div>
          </div>
          
          <!-- Visualización para modo de 3 jugadores -->
          <div class="pong-canvas three-players" *ngIf="playerCount === 3 && !isTournament">
            <div class="paddle paddle-p1"></div>
            <div class="paddle paddle-p2"></div>
            <div class="paddle paddle-p3"></div>
            <div class="ball"></div>
          </div>
          
          <!-- Visualización para modo de 4 jugadores o torneo -->
          <div class="pong-canvas four-players" *ngIf="(playerCount === 4 && !isTournament) || (isTournament && !gameEnded)">
            <div class="paddle paddle-p1"></div>
            <div class="paddle paddle-p2"></div>
            <div class="paddle paddle-p3"></div>
            <div class="paddle paddle-p4"></div>
            <div class="ball"></div>
          </div>
          
          <!-- Visualización de resultados del torneo -->
          <div class="tournament-results" *ngIf="isTournament && gameEnded && tournamentWinner">
            <h3>¡Torneo finalizado!</h3>
            <div class="tournament-winner">
              <span class="winner-label">Campeón:</span>
              <span class="winner-name">{{ tournamentWinner ? tournamentWinner.username : 'No determinado' }}</span>
            </div>
            
            <div class="tournament-bracket">
              <h4>Resultados:</h4>
              <div class="tournament-match-result" *ngFor="let match of tournamentMatches; let i = index">
                <div class="match-round">
                  {{ i === 0 ? '1ª Semifinal' : i === 1 ? '2ª Semifinal' : 'FINAL' }}
                </div>
                <div class="match-score">
                  {{ match.player1.username }} {{ match.player1Score }} - {{ match.player2Score }} {{ match.player2.username }}
                </div>
                <div class="match-winner">
                  Ganador: {{ match.winner ? match.winner.username : 'No determinado' }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Controles de juego -->
        <div class="game-controls">
          <p *ngIf="!gameEnded && !isTournament">La partida está en curso...</p>
          <p *ngIf="!gameEnded && isTournament && currentMatch">
            {{ currentMatch.player1.username }} vs {{ currentMatch.player2.username }}
          </p>
          
          <button class="back-button" (click)="goBack()">
            Salir
          </button>
        </div>
      </div>
    </div>
    
  </div>
</div>